<style>
  body {
    font-family: sans-serif;
    margin: 20px;
    background-color: #f0f0f0;
  }
  h2 {
    margin-top: 0;
    color: #333;
  }
  .container {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 10px;
    color: #555;
  }
  textarea, input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }
  button {
    margin-top: 10px;
    padding: 8px 16px;
    background-color: #18A0FB;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #ccc;
  }
  #cancel {
    background-color: #FF4D4D;
  }
  #error {
    color: red;
    margin-top: 10px;
  }
  #status, #layerCount, #progress, #tokenInfo {
    margin-bottom: 10px;
  }
  #screenshot-container {
    margin-top: 20px;
    text-align: center;
  }
  #screenshot-thumbnail {
    max-width: 100px;
    max-height: 100px;
    cursor: pointer;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  #screenshot-fullsize {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  #screenshot-fullsize img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
  }
  .tabs {
    display: flex;
    margin-bottom: 20px;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-bottom: none;
  }
  .tab.active {
    background-color: white;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .info {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  a {
    color: #18A0FB;
  }
</style>

<div class="container">
  <h2>AI Rename Layers</h2>
  
  <div class="tabs">
    <div class="tab active" data-tab="generate">Generate</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>
  
  <div id="generate" class="tab-content active">
    <p id="status">Initializing...</p>
    <p id="layerCount"></p>
    <p id="progress"></p>
    <p id="tokenInfo"></p>
    
    <label for="structure">UI Structure:</label>
    <textarea id="structure" rows="10" cols="50" readonly></textarea>
    
    <label for="colorTheme">Color Theme:</label>
    <textarea id="colorTheme" rows="2" cols="50" readonly></textarea>
    
    <label for="context">Additional Context (optional):</label>
    <textarea id="context" rows="4" cols="50" placeholder="Add any additional information here..."></textarea>
    
    <label for="temperature">Temperature:</label>
    <input type="number" id="temperature" min="0" max="2" step="0.01" value="0.85">
    
    <div id="screenshot-container" style="display: none;">
      <h3>Screenshot:</h3>
      <img id="screenshot-thumbnail" alt="UI Screenshot" />
    </div>
    
    <div id="screenshot-fullsize">
      <img id="screenshot-large" alt="Full-size UI Screenshot" />
    </div>
    
    <p id="error" style="color: red;"></p>
    
    <button id="analyze">Analyze Screenshot</button>
    <button id="start" disabled>Start Renaming</button>
    <button id="cancel">Cancel</button>
    <button id="simpleRename">Simple Rename</button>
  </div>
  
  <div id="settings" class="tab-content">
    <label for="apiKey">OpenRouter API Key:</label>
    <input type="text" id="apiKey" placeholder="Enter your OpenRouter API key">
    <p class="info">You need an OpenRouter API key. Get it <a href="https://openrouter.ai/keys" target="_blank">here</a>.</p>
    
    <label for="analysisModel">Analysis Model:</label>
    <input type="text" id="analysisModel" placeholder="Enter model for analysis">
    
    <label for="renamingModel">Renaming Model:</label>
    <input type="text" id="renamingModel" placeholder="Enter model for renaming">
    
    <button id="saveSettings">Save Settings</button>
  </div>
</div>

<script>
let selectedLayers = 0;
let totalLayers = 0;

// Load saved settings
function loadSettings() {
  parent.postMessage({ pluginMessage: { type: 'loadSettings' } }, '*');
}

// Save settings
function saveSettings() {
  const apiKey = document.getElementById('apiKey').value;
  const analysisModel = document.getElementById('analysisModel').value;
  const renamingModel = document.getElementById('renamingModel').value;
  
  parent.postMessage({ 
    pluginMessage: { 
      type: 'saveSettings', 
      apiKey, 
      analysisModel, 
      renamingModel 
    } 
  }, '*');
  
  updateUI();
  alert('Settings saved successfully!');
}

// Tab switching logic
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.tab).classList.add('active');
  });
});

window.onmessage = (event) => {
  const message = event.data.pluginMessage;
  if (message.type === 'settingsLoaded') {
    document.getElementById('apiKey').value = message.apiKey || '';
    document.getElementById('analysisModel').value = message.analysisModel || '';
    document.getElementById('renamingModel').value = message.renamingModel || '';
    updateUI();
  } else if (message.type === 'error') {
    document.getElementById('error').textContent = `Error: ${message.message}`;
    if (message.details) {
      console.error('Error details:', message.details);
    }
    document.getElementById('analyze').disabled = false;
    document.getElementById('start').disabled = false;
    document.getElementById('status').textContent = 'An error occurred';
  } else if (message.type === 'retryEnabled') {
    document.getElementById('start').disabled = false;
  } else if (message.type === 'context') {
    document.getElementById('structure').value = message.structure;
    document.getElementById('colorTheme').value = message.colorTheme;
    document.getElementById('start').disabled = false;
    document.getElementById('analyze').disabled = true;
    document.getElementById('status').textContent = 'Analysis complete. Ready to rename layers.';
    
    // Display the screenshot
    if (message.screenshot) {
      const screenshotContainer = document.getElementById('screenshot-container');
      const screenshotThumbnail = document.getElementById('screenshot-thumbnail');
      const screenshotLarge = document.getElementById('screenshot-large');
      if (screenshotThumbnail && screenshotLarge) {
        const uint8Array = new Uint8Array(message.screenshot);
        const blob = new Blob([uint8Array], { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        screenshotThumbnail.src = url;
        screenshotLarge.src = url;
        screenshotContainer.style.display = 'block';
      }
    }
  } else if (message.type === 'tokenInfo') {
    document.getElementById('tokenInfo').textContent = `Input tokens: ${message.inputTokens}, Output tokens: ${message.outputTokens}, Estimated cost: $${message.estimatedCost}`;
  } else if (message.type === 'selectionUpdate') {
    selectedLayers = message.selectedCount;
    totalLayers = message.totalCount;
    updateUI();
  } else if (message.type === 'progress') {
    document.getElementById('progress').textContent = `Progress: ${message.current}/${message.total}`;
  } else if (message.type === 'complete') {
    document.getElementById('status').textContent = `Renaming complete! Renamed ${message.renamedCount} layers.`;
    document.getElementById('progress').textContent = '';
    document.getElementById('start').disabled = false;
    document.getElementById('error').textContent = '';
  }
};

function updateUI() {
  const layerCountElement = document.getElementById('layerCount');
  if (selectedLayers === 0) {
    layerCountElement.textContent = 'No layers selected.';
  } else {
    layerCountElement.textContent = `Selected layers: ${selectedLayers} (Total including sublayers: ${totalLayers})`;
  }
  const settingsComplete = checkSettings();
  document.getElementById('analyze').disabled = selectedLayers === 0 || !settingsComplete;
  document.getElementById('start').disabled = true;
  document.getElementById('status').textContent = selectedLayers === 0 ? 'No layers selected.' : 
    (!settingsComplete ? 'Please enter API key and model names in settings.' : 'Ready to analyze screenshot.');
  document.getElementById('progress').textContent = '';
  document.getElementById('error').textContent = '';
  document.getElementById('tokenInfo').textContent = '';
  document.getElementById('simpleRename').disabled = selectedLayers === 0;
}

function checkSettings() {
  const apiKey = document.getElementById('apiKey').value;
  const analysisModel = document.getElementById('analysisModel').value;
  const renamingModel = document.getElementById('renamingModel').value;
  return apiKey !== '' && analysisModel !== '' && renamingModel !== '';
}

document.getElementById('context').addEventListener('input', function() {
  const isEmpty = this.value.trim() === '';
  document.getElementById('analyze').disabled = !isEmpty && selectedLayers > 0;
  document.getElementById('start').disabled = isEmpty;
});

document.getElementById('analyze').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'start-analysis' } }, '*');
  document.getElementById('status').textContent = 'Analyzing screenshot...';
  document.getElementById('analyze').disabled = true;
  document.getElementById('error').textContent = '';
};

document.getElementById('start').onclick = () => {
  const temperature = parseFloat(document.getElementById('temperature').value);
  const structure = document.getElementById('structure').value;
  const colorTheme = document.getElementById('colorTheme').value;
  const additionalContext = document.getElementById('context').value;
  
  const fullContext = `UI Structure:\n${structure}\n\nColor Theme:\n${colorTheme}\n\nAdditional Context:\n${additionalContext}`;
  
  parent.postMessage({ pluginMessage: { type: 'start-renaming', temperature, context: fullContext } }, '*');
  document.getElementById('status').textContent = 'Renaming layers...';
  document.getElementById('start').disabled = true;
  document.getElementById('error').textContent = '';
};

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
};

document.getElementById('saveSettings').onclick = saveSettings;

// Screenshot handling
document.getElementById('screenshot-thumbnail').addEventListener('click', function() {
  document.getElementById('screenshot-fullsize').style.display = 'flex';
});

document.getElementById('screenshot-fullsize').addEventListener('click', function() {
  this.style.display = 'none';
});

// Load settings on startup
loadSettings();

// Request initial selection info
parent.postMessage({ pluginMessage: { type: 'requestSelection' } }, '*');

document.getElementById('simpleRename').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'start-simple-renaming' } }, '*');
  document.getElementById('status').textContent = 'Performing simple renaming...';
  document.getElementById('simpleRename').disabled = true;
  document.getElementById('error').textContent = '';
};
</script>