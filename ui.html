<style>
  body {
    font-family: sans-serif;
    margin: 20px;
    background-color: #f0f0f0;
  }
  h2 {
    margin-top: 0;
    color: #333;
  }
  .container {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  label {
    display: block;
    margin-top: 10px;
    color: #555;
  }
  textarea, input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }
  button {
    margin-top: 10px;
    padding: 8px 16px;
    background-color: #18A0FB;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #ccc;
  }
  #cancel {
    background-color: #FF4D4D;
  }
  #error {
    color: red;
    margin-top: 10px;
  }
  #status, #layerCount {
    margin-bottom: 10px;
  }
  .tabs {
    display: flex;
    margin-bottom: 20px;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-bottom: none;
  }
  .tab.active {
    background-color: white;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .info {
    font-size: 12px;
    color: #666;
    margin-top: 5px;
  }
  a {
    color: #18A0FB;
  }
</style>

<div class="container">
  <h2>AI Rename Layers</h2>
  
  <div class="tabs">
    <div class="tab active" data-tab="rename">Rename</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>
  
  <div id="rename" class="tab-content active">
    <p id="status">Ready to rename layers.</p>
    <p id="layerCount"></p>
    
    <label for="aiResponse">AI Analysis:</label>
    <textarea id="aiResponse" rows="10" cols="50" readonly></textarea>
    
    <p id="error" style="color: red;"></p>
    
    <button id="start">Start Renaming</button>
    <button id="cancel">Cancel</button>
  </div>
  
  <div id="settings" class="tab-content">
    <label for="apiKey">OpenRouter API Key:</label>
    <input type="text" id="apiKey" placeholder="Enter your OpenRouter API key">
    <p class="info">You need an OpenRouter API key. Get it <a href="https://openrouter.ai/keys" target="_blank">here</a>.</p>
    
    <label for="analysisModel">Analysis Model:</label>
    <input type="text" id="analysisModel" placeholder="Enter model for analysis">
    
    <button id="saveSettings">Save Settings</button>
  </div>
</div>

<script>
let selectedLayers = 0;
let totalLayers = 0;

function loadSettings() {
  parent.postMessage({ pluginMessage: { type: 'loadSettings' } }, '*');
}

function saveSettings() {
  const apiKey = document.getElementById('apiKey').value;
  const analysisModel = document.getElementById('analysisModel').value;
  
  parent.postMessage({ 
    pluginMessage: { 
      type: 'saveSettings', 
      apiKey, 
      analysisModel 
    } 
  }, '*');
  
  updateUI();
  alert('Settings saved successfully!');
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.tab).classList.add('active');
  });
});

window.onmessage = (event) => {
  const message = event.data.pluginMessage;
  if (message.type === 'settingsLoaded') {
    document.getElementById('apiKey').value = message.apiKey || '';
    document.getElementById('analysisModel').value = message.analysisModel || '';
    updateUI();
  } else if (message.type === 'error') {
    document.getElementById('error').textContent = `Error: ${message.message}`;
    if (message.details) {
      console.error('Error details:', message.details);
    }
    document.getElementById('start').disabled = false;
    document.getElementById('status').textContent = 'An error occurred';
  } else if (message.type === 'complete') {
    document.getElementById('status').textContent = message.message;
    document.getElementById('aiResponse').value = message.context;
    document.getElementById('start').disabled = false;
    document.getElementById('error').textContent = '';
  } else if (message.type === 'selectionUpdate') {
    selectedLayers = message.selectedCount;
    totalLayers = message.totalCount;
    updateUI();
  }
};

function updateUI() {
  const layerCountElement = document.getElementById('layerCount');
  if (selectedLayers === 0) {
    layerCountElement.textContent = 'No layers selected.';
  } else {
    layerCountElement.textContent = `Selected layers: ${selectedLayers} (Total including sublayers: ${totalLayers})`;
  }
  const settingsComplete = checkSettings();
  document.getElementById('start').disabled = selectedLayers === 0 || !settingsComplete;
  document.getElementById('status').textContent = selectedLayers === 0 ? 'No layers selected.' : 
    (!settingsComplete ? 'Please enter API key and model name in settings.' : 'Ready to rename layers.');
  document.getElementById('error').textContent = '';
  document.getElementById('aiResponse').value = '';
}

function checkSettings() {
  const apiKey = document.getElementById('apiKey').value;
  const analysisModel = document.getElementById('analysisModel').value;
  return apiKey !== '' && analysisModel !== '';
}

document.getElementById('start').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'start-renaming' } }, '*');
  document.getElementById('status').textContent = 'Renaming layers...';
  document.getElementById('start').disabled = true;
  document.getElementById('error').textContent = '';
};

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
};

document.getElementById('saveSettings').onclick = saveSettings;

loadSettings();

parent.postMessage({ pluginMessage: { type: 'requestSelection' } }, '*');
</script>